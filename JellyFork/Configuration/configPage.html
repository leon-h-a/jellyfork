<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyFork</title>
</head>
<body>
    <div id="configPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="config">
                    <div class="jfSection">

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="inputDirectory">Downloads directory</label>
                            <input id="inputDirectory" is="emby-input" value="" />
                            <div class="fieldDescription">
                                Define directory where media is being downloaded (ie. /user/downloads)
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="outputDirectory">Media directory</label>
                            <input id="outputDirectory" is="emby-input" value="" />
                            <div class="fieldDescription">
                                Define your output directory (ie. /user/movies or /user/shows)
                            </div>
                        </div>

                        <button type="submit" class="raised button-submit block emby-button">
                            <span>Update configuration</span>
                        </button>
                    </div>
                </form>
                <br>

                <div class="jfSection ">
                    <div>
                        <table style="width: 100%;" id="media-available">
                            <thead>
                                <tr>
                                    <th>File name</th>
                                    <th>Ext.</th>
                                    <th>Edit</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <br>

                    <button id="scanMedia" class="raised button-submit block emby-button">
                        <span>Scan for new media</span>
                    </button>
                </div>
                <br>

                <div class="jfSection">
                    <label class="inputLabel inputLabelUnfocused" for="movieMedia">Select new name</label>
                    <input id="newNameInput" is="emby-input"/>
                    <div class="fieldDescription">
                        Enter new file name without extension (.mp4, .srt)
                    </div>
                    <br>

                    <button id="newNameBtn" type="submit" class="raised button-submit block emby-button">
                        <span>Rename and move</span>
                    </button>
                </div>
                <br>
            </div>
        </div>

        <script type="text/javascript">
            var JellyForkConfig = {
                pluginUniqueId: '6aabd9ed-969f-4225-b316-6b3b33a2fddb'
            };

            document.querySelector('#configPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyForkConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#inputDirectory').value = config.InputDir;
                        document.querySelector('#outputDirectory').value = config.OutputDir;
                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#config')
                .addEventListener('submit', function(e) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyForkConfig.pluginUniqueId).then(function (config) {
                        config.InputDir = document.querySelector('#inputDirectory').value;
                        config.OutputDir = document.querySelector('#outputDirectory').value;
                        ApiClient.updatePluginConfiguration(JellyForkConfig.pluginUniqueId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                    e.preventDefault();
                    return false;
                });

            const getFileExtension = (filename) => {
                const parts = filename.split('.');
                return parts.length > 1 ? parts.pop() : 'N/A';
            };



            document.getElementById('scanMedia')
                .addEventListener('click', () => { 
                    const table = document.getElementById('media-available');
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => row.remove());

                    $.ajax({
                        type: 'POST',
                        url: '/plugins/jellyfork/getmedia',
                        data: {
                            inputDirectory: document.querySelector('#inputDirectory').value
                        },
                        success: function (response) {

                            const tableBody = document.querySelector('#media-available tbody');

                            function processDirectory(directory) {
                                if (directory.Files && Array.isArray(directory.Files)) {
                                    directory.Files.forEach(file => {
                                        const row = document.createElement('tr');

                                        const fileCell = document.createElement('td');
                                        fileCell.className = "truncated";
                                        fileCell.textContent = file.Name;
                                        fileCell.setAttribute('data-fullpath', file.FullPath);
                                        row.appendChild(fileCell);

                                        const extCell = document.createElement('td');
                                        extCell.setAttribute('class', "ext-cell");
                                        extCell.textContent = getFileExtension(file.Name);
                                        row.appendChild(extCell);

                                        const editCell = document.createElement('td');
                                        const checkbox = document.createElement('input');
                                        editCell.setAttribute('class', "edit-cell");
                                        checkbox.type = 'checkbox';
                                        checkbox.value = file.FullPath;
                                        editCell.appendChild(checkbox);
                                        row.appendChild(editCell);

                                        tableBody.appendChild(row);                            
                                    });
                                };
                                if (directory.Subdirectories && Array.isArray(directory.Subdirectories)) {
                                    directory.Subdirectories.forEach(subdirectory => {
                                        processDirectory(subdirectory);
                                    });
                                }
                            };
                            rootDir = JSON.parse(response.data);
                            processDirectory(rootDir);
                        },
                        error: function (response) {
                            console.log('error');
                        }
                    });
                });

            document.getElementById('newNameBtn')
                .addEventListener('click', () => { 

                    var newNameStr = document.querySelector('#newNameInput').value;

                    const table = document.getElementById('media-available');
                    const selectedFiles = [];
                    const rows = table.querySelectorAll('tbody tr');

                    rows.forEach(row => {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        if (checkbox && checkbox.checked) {
                            const filenameCell = row.querySelector('td:first-child');
                            if (filenameCell) {
                                selectedFiles.push(filenameCell.getAttribute("data-fullpath").trim());
                            }
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: '/plugins/jellyfork/rename',
                        data: {
                            inputDirectory: document.querySelector('#inputDirectory').value,
                            outputDirectory: document.querySelector('#outputDirectory').value,
                            newName: document.querySelector('#newNameInput').value,
                            files: selectedFiles
                        }
                    });
                    document.getElementById('scanMedia').click();
                });

        </script>

        <style>
            .fileExtension {
                text-align: center;
            }
            .fileSelected {
                text-align: center;
            }
            .jfSection {
                border: 1px solid gray;
                border-radius: 5px;
                padding: 20px;
                margin: 10px;
                max-width: 50em;
            }
            #undoButton {
                background-color: red;
                width: 50%;
                margin: auto;
            }
            td {
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                max-width: 120px;
                padding-top: 15px;
            }
            td.truncated {
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
            td.truncated:active{
                white-space: normal;
                overflow-wrap: break-word;
                word-break: break-word;
                user-select: none;
            }
            .ext-cell {
                text-align: center;
            }
            .edit-cell {
                text-align: center;
            }
        </style>

    </div>
</body>
</html>
