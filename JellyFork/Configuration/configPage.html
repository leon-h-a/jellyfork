<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyFork</title>
</head>
<body>
    <div id="configPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="config">
                    <div class="jfSection">

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="inputDirectory">Downloads directory</label>
                            <input id="inputDirectory" is="emby-input" value="" />
                            <div class="fieldDescription">
                                Define directory where media is being downloaded (ie. /user/downloads)
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="outputDirectory">Media directory</label>
                            <input id="outputDirectory" is="emby-input" value="" />
                            <div class="fieldDescription">
                                Define your output directory (ie. /user/movies or /user/shows)
                            </div>
                        </div>

                        <button type="submit" class="raised button-submit block emby-button">
                            <span>Update configuration</span>
                        </button>
                    </div>
                </form>
                <br>

                    <div class="jfSection">
                        <div>
                            <table style="width: 100%;" id="media-available">
                                <thead>
                                    <tr>
                                        <th>File name</th>
                                        <th>File type</th>
                                        <th>Edit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>

                        <button id="scanMedia" class="raised button-submit block emby-button">
                            <span>Scan for new media</span>
                        </button>
                    </div>
                <br>

                <form id="moveMedia">
                    <div class="jfSection">
                        <label class="inputLabel inputLabelUnfocused" for="movieMedia">Select new name</label>
                        <input id="movieMedia" is="emby-input"/>
                        <div class="fieldDescription">
                            Enter new file name without extension (.mp4, .srt)
                        </div>

                        <button type="submit" class="raised button-submit block emby-button">
                            <span>Rename and move</span>
                        </button>
                    </div>
                </form>
                <br>

                <form id="undoLastAction">
                    <button id="undoButton" type="submit" class="raised button-submit block emby-button">
                        <span>Undo last action</span>
                    </button>
                </form>

            </div>
        </div>

        <script type="text/javascript">
            var JellyForkConfig = {
                pluginUniqueId: '6aabd9ed-969f-4225-b316-6b3b33a2fddb'
            };

            document.querySelector('#configPage')
                .addEventListener('pageshow', function() {
                    console.log("initial load");
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyForkConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#inputDirectory').value = config.InputDir;
                        document.querySelector('#outputDirectory').value = config.OutputDir;
                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#config')
                .addEventListener('submit', function(e) {
                    console.log("update config");
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyForkConfig.pluginUniqueId).then(function (config) {
                        config.InputDir = document.querySelector('#inputDirectory').value;
                        config.OutputDir = document.querySelector('#outputDirectory').value;
                        ApiClient.updatePluginConfiguration(JellyForkConfig.pluginUniqueId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                    e.preventDefault();
                    return false;
                });

            const getFileExtension = (filename) => {
                const parts = filename.split('.');
                return parts.length > 1 ? parts.pop() : 'N/A';
            };



            document.getElementById('scanMedia')
                .addEventListener('click', () => { 
                    $.ajax({
                        type: 'POST',
                        url: '/plugins/jellyfork/getmedia',
                        data: {
                            inputDirectory: document.querySelector('#inputDirectory').value
                        },
                        success: function (response) {
                            <!-- console.log(response.data); -->

                            const tableBody = document.querySelector('#media-available');

                            const processDirectory = (directory) => {
                                console.log(directory);
                                if (directory.Files && Array.isArray(directory.Files)) {
                                    directory.Files.forEach(file => {
                                        const row = document.createElement('tr');

                                        const fileCell = document.createElement('td');
                                        fileCell.className = "truncated";
                                        fileCell.textContent = file.Name;
                                        fileCell.setAttribute('data-fulltext', file.Name);
                                        row.appendChild(fileCell);

                                        const extCell = document.createElement('td');
                                        extCell.textContent = getFileExtension(file.Name);
                                        row.appendChild(extCell);

                                        const editCell = document.createElement('td');
                                        const checkbox = document.createElement('input');
                                        checkbox.type = 'checkbox';
                                        checkbox.value = file.FullPath;
                                        editCell.appendChild(checkbox);
                                        row.appendChild(editCell);

                                        tableBody.appendChild(row);                            
                                    });
                                };
                                if (directory.Subdirectories && Array.isArray(directory.Subdirectories)) {
                                    directory.Subdirectories.forEach(subdirectory => {
                                        processDirectory(subdirectory);
                                    });
                                }
                            };
                            processDirectory(response.data);
                        },
                        error: function (response) {
                            console.log('error');
                        }
                    });
                });

        </script>

        <style>
            .fileExtension {
                text-align: center;
            }
            .fileSelected {
                text-align: center;
            }
            .jfSection {
                border: 1px solid gray;
                border-radius: 5px;
                padding: 20px;
                margin: 10px;
            }
            #undoButton {
                background-color: red;
                width: 30%;
                margin: auto;
            }
        </style>

    </div>
</body>
</html>
